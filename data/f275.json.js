window.repositoryObject = {"parameters_custom_fields":[],"object_id":"f275","name":"public.search_call","subtype":"FUNCTION","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Hasura","id":"d4"}},{"field":"Schema","value":"public"},{"field":"Name","value":"search_call"},{"field":"Type","value":"Function"}],"script":"CREATE OR REPLACE FUNCTION public.search_call(hasura_session json, _id integer DEFAULT NULL::integer, _search text DEFAULT NULL::text, _datefrom timestamp with time zone DEFAULT NULL::timestamp with time zone, _dateto timestamp with time zone DEFAULT NULL::timestamp with time zone, _orgstructure text DEFAULT NULL::text, _is_incoming boolean DEFAULT NULL::boolean, _for_survey boolean DEFAULT NULL::boolean, _has_survey boolean DEFAULT NULL::boolean, _has_csat boolean DEFAULT NULL::boolean, _search_speech text DEFAULT NULL::text, _search_speech_ms text DEFAULT NULL::text, _limit integer DEFAULT 100, _offset integer DEFAULT 0)\r\n RETURNS SETOF call\r\n LANGUAGE plpgsql\r\n STABLE\r\nAS $function$\r\nDECLARE\r\n  acl_path_regexp text[];\r\n  acl_provider Int[];\r\n  select_query text;\r\nBEGIN\r\n    /* запрос */\r\n    select_query := 'SELECT c.* FROM call c LEFT JOIN org_structure o ON o.id = c.org_structure_id WHERE ';\r\n\r\n    /* ограничение по оргструктуре и провайдеру */\r\n    IF _orgstructure IS NOT NULL THEN\r\n        select_query := select_query || ' o.path SIMILAR TO ' || quote_literal(_orgstructure);\r\n      ELSE\r\n        /* ACL по оргструктуре или провайдерам */\r\n        acl_path_regexp := get_acl_path_regexp(hasura_session);\r\n        SELECT array(select id FROM get_provider(hasura_session)) INTO acl_provider;\r\n\r\n        select_query := select_query || ' ( ';\r\n\r\n        IF array_length(acl_provider,1) > 0 THEN\r\n          select_query := select_query || ' c.provider_id IN (' || array_to_string(acl_provider, ',' ) || ') OR ';\r\n        END IF;\r\n\r\n        select_query := select_query || ' o.path LIKE ANY (' || quote_literal(acl_path_regexp) || ')) ';\r\n    END IF;\r\n\r\n    /* поиск по ID */\r\n    IF _id IS NOT NULL THEN\r\n        select_query := select_query || ' AND c.id = ' || _id;\r\n    END IF;\r\n\r\n    /* поиск по звонкам */\r\n    IF _search IS NOT NULL THEN\r\n        select_query := select_query || ' AND fts @@ websearch_to_tsquery(''russian'', ' || quote_literal(_search) || ')';\r\n    END IF;\r\n\r\n    /* ограничение по дате ОТ */\r\n    IF _datefrom IS NOT NULL THEN\r\n        select_query := select_query || ' AND c.created_at >= ' || quote_literal(_datefrom);\r\n    END IF;\r\n\r\n    /* ограничение по дате ДО */\r\n    IF _dateto IS NOT NULL THEN\r\n        select_query := select_query || ' AND c.created_at <= ' || quote_literal(_dateto);\r\n    END IF;\r\n\r\n    /* Фильтр по типу (входящий/исходящий) */\r\n    IF _is_incoming IS NOT NULL THEN\r\n      IF _is_incoming = TRUE THEN\r\n        select_query := select_query || ' AND c.is_incoming = TRUE';\r\n      ELSE\r\n        select_query := select_query || ' AND c.is_incoming = FALSE';\r\n      END IF;\r\n    END IF;\r\n\r\n    /* Звонки для оценки (с записью и длительность > 10 секунд */\r\n    IF _for_survey IS NOT NULL THEN\r\n        select_query := select_query || ' AND c.record IS NOT NULL AND c.billsec > 10 ';\r\n    END IF;\r\n\r\n    /* Звонки с фильтром по CSAT */\r\n    IF _has_csat IS NOT NULL THEN\r\n      IF _has_csat = TRUE THEN\r\n        select_query := select_query || ' AND EXISTS (SELECT * FROM csat WHERE csat.call_id = c.id) ';\r\n      ELSE\r\n        select_query := select_query || ' AND NOT EXISTS (SELECT * FROM csat WHERE csat.call_id = c.id) ';\r\n      END IF;\r\n    END IF;\r\n\r\n    /* поиск по тексту звонка Google */\r\n    IF _search_speech IS NOT NULL THEN\r\n        select_query := select_query || ' AND fts_speech @@ websearch_to_tsquery(''russian'', ' || quote_literal(_search_speech) || ')';\r\n    END IF;\r\n\r\n    /* поиск по тексту звонка MS */\r\n    IF _search_speech_ms IS NOT NULL THEN\r\n        select_query := select_query || ' AND fts_speech_ms @@ websearch_to_tsquery(''russian'', ' || quote_literal(_search_speech_ms) || ')';\r\n    END IF;\r\n\r\n    /* order by */\r\n    select_query := select_query || ' ORDER BY c.id DESC ';\r\n\r\n    /* limit */\r\n    IF _limit IS NOT NULL THEN\r\n      select_query := select_query || ' LIMIT ' || _limit || ' OFFSET ' || _offset;\r\n    END IF;\r\n\r\n    RETURN QUERY EXECUTE select_query;\r\nEND\r\n$function$","parameters":[{"name":"Returns","description":null,"mode":"OUT","data_type":"call","custom_fields":{}},{"name":"hasura_session","description":null,"mode":"IN","data_type":"json","custom_fields":{}},{"name":"_id","description":null,"mode":"IN","data_type":"integer","custom_fields":{}},{"name":"_search","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_datefrom","description":null,"mode":"IN","data_type":"timestamp with time zone","custom_fields":{}},{"name":"_dateto","description":null,"mode":"IN","data_type":"timestamp with time zone","custom_fields":{}},{"name":"_orgstructure","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_is_incoming","description":null,"mode":"IN","data_type":"boolean","custom_fields":{}},{"name":"_for_survey","description":null,"mode":"IN","data_type":"boolean","custom_fields":{}},{"name":"_has_survey","description":null,"mode":"IN","data_type":"boolean","custom_fields":{}},{"name":"_has_csat","description":null,"mode":"IN","data_type":"boolean","custom_fields":{}},{"name":"_search_speech","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_search_speech_ms","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_limit","description":null,"mode":"IN","data_type":"integer","custom_fields":{}},{"name":"_offset","description":null,"mode":"IN","data_type":"integer","custom_fields":{}}],"dependencies":{"uses":[],"used_by":[]},"imported_at":"2024-02-15 12:25"};