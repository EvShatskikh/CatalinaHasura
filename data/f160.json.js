window.repositoryObject = {"parameters_custom_fields":[],"object_id":"f160","name":"public.calc_operator_status","subtype":"FUNCTION","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Hasura","id":"d4"}},{"field":"Schema","value":"public"},{"field":"Name","value":"calc_operator_status"},{"field":"Type","value":"Function"}],"script":"CREATE OR REPLACE FUNCTION public.calc_operator_status(_datefrom timestamp with time zone DEFAULT NULL::timestamp with time zone, _dateto timestamp with time zone DEFAULT NULL::timestamp with time zone, _operators text DEFAULT NULL::text)\r\n RETURNS SETOF operator_status_log\r\n LANGUAGE plpgsql\r\n STABLE\r\nAS $function$ \r\nDECLARE\r\n  operators_array int[];\r\nBEGIN\r\n  IF _operators IS NOT NULL THEN\r\n    operators_array := string_to_array(_operators, '|')::int[];\r\n\r\n    RETURN QUERY \r\n    SELECT MAX(id), operator, status, MIN(created_at) as created_at, MAX(created_by) as created_by, MIN(date_from) as date_from, MAX(date_to) as date_to, \r\n    SUM(EXTRACT(EPOCH FROM ((CASE WHEN date_to IS NOT NULL THEN date_to ELSE now() END) - date_from)))::int as  calc\r\n    FROM operator_status_log \r\n    WHERE date_from >=_datefrom AND date_from <= _dateto AND operator = ANY(operators_array) AND status != 'offline'\r\n    GROUP BY operator, status;\r\n  ELSE\r\n    RETURN QUERY \r\n    SELECT MAX(id), operator, status, MIN(created_at) as created_at, MAX(created_by) as created_by, MIN(date_from) as date_from, MAX(date_to) as date_to, \r\n    SUM(EXTRACT(EPOCH FROM ((CASE WHEN date_to IS NOT NULL THEN date_to ELSE now() END) - date_from)))::int as  calc\r\n    FROM operator_status_log \r\n    WHERE date_from >=_datefrom AND date_from <= _dateto AND status != 'offline'\r\n    GROUP BY operator, status;\r\n  END IF;\r\n\r\n  RETURN;\r\nEND\r\n$function$","parameters":[{"name":"Returns","description":null,"mode":"OUT","data_type":"operator_status_log","custom_fields":{}},{"name":"_datefrom","description":null,"mode":"IN","data_type":"timestamp with time zone","custom_fields":{}},{"name":"_dateto","description":null,"mode":"IN","data_type":"timestamp with time zone","custom_fields":{}},{"name":"_operators","description":null,"mode":"IN","data_type":"text","custom_fields":{}}],"dependencies":{"uses":[],"used_by":[]},"imported_at":"2024-02-15 12:25"};