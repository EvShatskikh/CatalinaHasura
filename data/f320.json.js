window.repositoryObject = {"parameters_custom_fields":[],"object_id":"f320","name":"public.get_operator_for_issue","subtype":"FUNCTION","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Hasura","id":"d4"}},{"field":"Schema","value":"public"},{"field":"Name","value":"get_operator_for_issue"},{"field":"Type","value":"Function"}],"script":"CREATE OR REPLACE FUNCTION public.get_operator_for_issue(_pos_id bigint DEFAULT NULL::bigint, _provider_id integer DEFAULT NULL::integer)\r\n RETURNS SETOF \"user\"\r\n LANGUAGE plpgsql\r\n STABLE\r\nAS $function$\r\nDECLARE\r\n  _user_to_assign text := NULL;\r\nBEGIN\r\n\r\n    /* Оператор по владельцу ТТ (только если на исходе и активен) */\r\n    IF _pos_id IS NOT NULL THEN\r\n      select u.email INTO _user_to_assign\r\n      from pos p\r\n      join org_structure o on o.id = p.org_structure_id and o.is_active = true\r\n      join public.user u on u.org_structure_id = o.t1_org_structure_id and u.is_active = true\r\n      join user_m2m_group u2g on u.email = u2g.user_id\r\n      join user_group ug on ug.name = u2g.group_id and ug.provider_id = _provider_id and ug.name ilike '%исход%'\r\n      join operator_status os on os.operator = u.operator_number  and status IN ('online', 'processing', 'autoorder')\r\n      where p.id = _pos_id and not exists\r\n        (\r\n        select 1 from user_m2m_group u2g2\r\n        join user_group ug2 on ug2.name = u2g2.group_id and ug2.provider_id = _provider_id and ug2.name ilike '%вход%'\r\n        where u.email = u2g2.user_id\r\n        )\r\n      LIMIT 1;\r\n    END IF;\r\n\r\n    /* Свободный оператор на исходе с меньшим кол-вом запросов */\r\n    IF _user_to_assign IS NULL THEN\r\n      select u.email INTO _user_to_assign\r\n      from public.user u\r\n      join user_m2m_group u2g on u.email = u2g.user_id\r\n      join user_group ug on ug.name = u2g.group_id and ug.provider_id = _provider_id and ug.name ilike '%исход%'\r\n      join operator_status os on os.operator = u.operator_number and status IN ('online', 'processing', 'autoorder')\r\n      left join issue_assigned_count ic on ic.assigned_user_id = u.email\r\n      where u.is_active = true and not exists\r\n      (\r\n      select 1 from user_m2m_group u2g2\r\n      join user_group ug2 on ug2.name = u2g2.group_id and ug2.provider_id = _provider_id and ug2.name ilike '%вход%'\r\n      where u.email = u2g2.user_id\r\n      )\r\n      order by ic.callback_count NULLS FIRST, ic.count\r\n      limit 1;\r\n    END IF;\r\n\r\n    RETURN QUERY select * from public.user where email = _user_to_assign;\r\nEND\r\n$function$","parameters":[{"name":"Returns","description":null,"mode":"OUT","data_type":"user","custom_fields":{}},{"name":"_pos_id","description":null,"mode":"IN","data_type":"bigint","custom_fields":{}},{"name":"_provider_id","description":null,"mode":"IN","data_type":"integer","custom_fields":{}}],"dependencies":null,"imported_at":"2023-11-29 12:21"};