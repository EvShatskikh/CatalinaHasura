window.repositoryObject = {"parameters_custom_fields":[],"object_id":"f227","name":"public.issue_after_upsert_trigger","subtype":"FUNCTION","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Hasura","id":"d4"}},{"field":"Schema","value":"public"},{"field":"Name","value":"issue_after_upsert_trigger"},{"field":"Type","value":"Function"}],"script":"CREATE OR REPLACE FUNCTION public.issue_after_upsert_trigger()\r\n RETURNS trigger\r\n LANGUAGE plpgsql\r\nAS $function$  \r\nbegin  \r\n  /* Если поменялся на кого назначен запрос - записываем время */\r\n  IF COALESCE(old.assigned_user_id, '') != COALESCE(new.assigned_user_id, '') \r\n  OR COALESCE(old.assigned_group_id, '') != COALESCE(new.assigned_group_id,'') THEN     \r\n    /* старое назначение - ставим время завершения */\r\n    UPDATE issue_assigned_time SET date_to = now() WHERE issue_id = new.id AND date_to IS NULL;\r\n    /* новое назначение - ставим время начала */\r\n    INSERT INTO issue_assigned_time (issue_id, group_id, user_id, date_from) VALUES(new.id, new.assigned_group_id, new.assigned_user_id, now()); \r\n  END IF;  \r\n\r\n  /* Если запрос закрыт */\r\n  IF old.completed_at IS NULL AND new.completed_at IS NOT NULL THEN     \r\n    /* последнее назначение - ставим время завершения */\r\n    UPDATE issue_assigned_time SET date_to = now() WHERE issue_id = new.id AND date_to IS NULL;\r\n  END IF;  \r\n\r\n  /* Если запрос снова  открыт */\r\n  IF old.completed_at IS NOT NULL AND new.completed_at IS NULL THEN     \r\n    /* последнее назначение - ставим время начала */\r\n    INSERT INTO issue_assigned_time (issue_id, group_id, user_id, date_from) VALUES(new.id, new.assigned_group_id, new.assigned_user_id, now()); \r\n  END IF;  \r\n\r\n  RETURN new;\r\nend  \r\n$function$","parameters":[{"name":"Returns","description":null,"mode":"OUT","data_type":"trigger","custom_fields":{}}],"dependencies":null,"imported_at":"2023-11-29 12:21"};