window.repositoryObject = {"parameters_custom_fields":[],"object_id":"f233","name":"public.matrix_before_update_trigger","subtype":"FUNCTION","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Hasura","id":"d4"}},{"field":"Schema","value":"public"},{"field":"Name","value":"matrix_before_update_trigger"},{"field":"Type","value":"Function"}],"script":"CREATE OR REPLACE FUNCTION public.matrix_before_update_trigger()\r\n RETURNS trigger\r\n LANGUAGE plpgsql\r\nAS $function$  \r\nbegin  \r\n    /* Если матрица деактивирована - Добавляем событие matrix_delete  */\r\n    IF new.is_active = FALSE AND old.is_active = TRUE THEN \r\n        INSERT INTO matrix_event (matrix_id, action, created_at, created_by) VALUES(new.id, 'matrix_delete', new.updated_at, new.updated_by); \r\n    END IF;\r\n\r\n    /* Если матрица переименована - Добавляем событие matrix_rename  */\r\n    IF new.name != old.name THEN \r\n        INSERT INTO matrix_event (matrix_id, action, data, created_at, created_by) VALUES(new.id, 'matrix_rename', ('{\"name\": \"' || new.name || '\"}')::jsonb, new.updated_at, new.updated_by); \r\n    END IF;\r\n\r\n    /* Если матрице изменен регион - Добавляем событие matrix_region  */\r\n    IF new.region != old.region THEN \r\n        INSERT INTO matrix_event (matrix_id, action, data, created_at, created_by) VALUES(new.id, 'matrix_region', ('{\"name\": \"' || new.region || '\"}')::jsonb, new.updated_at, new.updated_by); \r\n    END IF;\r\n\r\n    /* Если матрице изменен атрибут is_auto - Добавляем событие matrix_auto  */\r\n    IF new.is_auto != old.is_auto THEN \r\n        INSERT INTO matrix_event (matrix_id, action, data, created_at, created_by) VALUES(new.id, 'matrix_auto', ('{\"name\": \"' || CASE WHEN new.is_auto = true THEN 'Автоматическая' ELSE 'Ручная' END || '\"}')::jsonb, new.updated_at, new.updated_by); \r\n    END IF;\r\n\r\n    /* Если изменены настройки авто матрицы  */\r\n    IF new.auto_filters != old.auto_filters THEN \r\n        INSERT INTO matrix_event (matrix_id, action, data, created_at, created_by) VALUES(new.id, 'matrix_auto_filters', new.auto_filters::jsonb, new.updated_at, new.updated_by); \r\n    END IF;\r\n\r\n  return new;\r\nend  \r\n$function$","parameters":[{"name":"Returns","description":null,"mode":"OUT","data_type":"trigger","custom_fields":{}}],"dependencies":{"uses":[],"used_by":[]},"imported_at":"2024-02-15 12:25"};