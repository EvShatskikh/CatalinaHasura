window.repositoryObject = {"parameters_custom_fields":[],"object_id":"f151","name":"plano.search_plano_sets","subtype":"FUNCTION","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Hasura","id":"d4"}},{"field":"Schema","value":"plano"},{"field":"Name","value":"search_plano_sets"},{"field":"Type","value":"Function"}],"script":"CREATE OR REPLACE FUNCTION plano.search_plano_sets(_search text DEFAULT NULL::text, _id integer DEFAULT NULL::integer, _is_auto boolean DEFAULT NULL::boolean, _without_pos boolean DEFAULT NULL::boolean, _info_filters text DEFAULT NULL::text, _path_filters text DEFAULT NULL::text, _sort_by text DEFAULT NULL::text, _desc text DEFAULT NULL::text, _limit integer DEFAULT NULL::integer, _offset integer DEFAULT 0)\r\n RETURNS SETOF plano.sets\r\n LANGUAGE plpgsql\r\n STABLE\r\nAS $function$\r\n\r\nDECLARE \r\n  select_query text;\r\n\r\nBEGIN\r\n    select_query := 'SELECT * FROM plano.sets ps WHERE is_active = true ';\r\n\r\n    /* поиск по названию и id матрицы */\r\n    IF _search IS NOT NULL THEN\r\n      select_query := select_query || ' AND ( ';\r\n      \r\n      IF _id IS NOT NULL THEN  \r\n        select_query := select_query || ' id = ' ||  _id || ' OR ';\r\n      END IF;\r\n      \r\n      select_query := select_query || ' name ILIKE ' || quote_literal('%' || _search || '%') || ') ';\r\n    END IF;\r\n\r\n    /* поиск по авто */\r\n    IF _is_auto IS NOT NULL THEN\r\n      IF _is_auto = TRUE THEN\r\n        select_query := select_query || ' AND is_auto = TRUE ';\r\n      ELSE\r\n        select_query := select_query || ' AND is_auto = FALSE ';\r\n      END IF;\r\n    END IF;\r\n\r\n    /* поиск по авто */\r\n    -- IF _created_by IS NOT NULL THEN\r\n    --   select_query := select_query || ' AND created_by_id = ' || quote_literal(_created_by);\r\n    -- END IF;\r\n\r\n    /* поиск без точек */\r\n    IF _without_pos = TRUE THEN\r\n      select_query := select_query || ' AND NOT EXISTS ( SELECT * FROM plano.set_m2m_pos m2p WHERE m2p.set_id = ps.id ) ';\r\n    END IF;\r\n\r\n    /* поиск по фильтрам , o.path_info as path_info  */\r\n    IF _info_filters IS NOT NULL OR _path_filters IS NOT NULL THEN\r\n        select_query := select_query || ' AND EXISTS (SELECT p.id FROM public.pos p '\r\n            || ' JOIN plano.set_m2m_pos m2p ON m2p.set_id = ps.id AND m2p.pos_id = p.id ';\r\n\r\n        IF _path_filters IS NOT NULL THEN\r\n          select_query := select_query || ' LEFT JOIN public.org_structure o ON o.id = p.org_structure_id ';\r\n        END IF;\r\n\r\n        select_query := select_query || ' WHERE for_matrix = true ';\r\n\r\n        IF _info_filters IS NOT NULL THEN\r\n          select_query := select_query ||  _info_filters;\r\n        END IF;\r\n\r\n        IF _path_filters IS NOT NULL THEN\r\n          select_query := select_query ||  _path_filters;\r\n        END IF;\r\n\r\n         select_query := select_query || ' ) ';\r\n    END IF;\r\n\r\n    /* order by */\r\n    IF _sort_by IS NOT NULL AND _desc IS NOT NULL THEN\r\n        select_query := select_query || ' ORDER BY ' || _sort_by || ' ' || _desc;\r\n    ELSE\r\n        select_query := select_query || ' ORDER BY id DESC ';\r\n    END IF;\r\n    \r\n    /* limit */\r\n    IF _limit IS NOT NULL THEN\r\n      select_query := select_query || ' LIMIT ' || _limit || ' OFFSET ' || _offset;\r\n    END IF;\r\n\r\n    RETURN QUERY EXECUTE select_query;\r\nEND $function$","parameters":[{"name":"Returns","description":null,"mode":"OUT","data_type":"sets","custom_fields":{}},{"name":"_search","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_id","description":null,"mode":"IN","data_type":"integer","custom_fields":{}},{"name":"_is_auto","description":null,"mode":"IN","data_type":"boolean","custom_fields":{}},{"name":"_without_pos","description":null,"mode":"IN","data_type":"boolean","custom_fields":{}},{"name":"_info_filters","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_path_filters","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_sort_by","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_desc","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_limit","description":null,"mode":"IN","data_type":"integer","custom_fields":{}},{"name":"_offset","description":null,"mode":"IN","data_type":"integer","custom_fields":{}}],"dependencies":null,"imported_at":"2023-11-29 12:21"};