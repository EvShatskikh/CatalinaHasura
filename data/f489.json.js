window.repositoryObject = {"parameters_custom_fields":[],"object_id":"f489","name":"equip.after_inventarisation_insert_add_issue_for_changed_bar_code","subtype":"FUNCTION","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Hasura","id":"d4"}},{"field":"Schema","value":"equip"},{"field":"Name","value":"after_inventarisation_insert_add_issue_for_changed_bar_code"},{"field":"Type","value":"Function"}],"script":"CREATE OR REPLACE FUNCTION equip.after_inventarisation_insert_add_issue_for_changed_bar_code()\r\n RETURNS trigger\r\n LANGUAGE plpgsql\r\nAS $function$\r\nDECLARE\r\n  sync_status text;\r\n  old_bar_code text;\r\n  old_nfc_code text;\r\nbegin\r\n  /* після зміни поля bar_code добавляєм запис для синхронізації в swe  */\r\n  IF (new.updated_by <> 'swe')\r\n    THEN sync_status := 'to-sync';\r\n    ELSE sync_status := 'synced_from_swe';\r\n  END IF;\r\n  \r\n  IF (new.bar_code IS NOT NULL)  THEN\r\n\r\n    select bar_code INTO old_bar_code from equip.equipment where id = new.equipment_id;\r\n\r\n    IF (new.bar_code <> old_bar_code) THEN\r\n      INSERT INTO equip.sync_smart_swe\r\n        (\"table\", field, object_id, swe_id, value, updated_by_source, updated_at_source, sync_status)\r\n      VALUES (\r\n        'inventarisation',\r\n        'bar_code_change',\r\n        new.equipment_id,\r\n        new.swe_id,\r\n        new.bar_code,\r\n        new.updated_by,\r\n        new.updated_at,\r\n        sync_status\r\n      );\r\n    END IF;\r\n  END IF;\r\n\r\n  IF (new.nfc_code IS NOT NULL) THEN\r\n\r\n    select nfc_code INTO old_nfc_code from equip.equipment where id = new.equipment_id;\r\n\r\n    IF (new.nfc_code <> old_nfc_code OR old_nfc_code IS NULL) THEN\r\n      UPDATE equip.equipment SET nfc_status_id = 1 WHERE id = new.equipment_id;\r\n    END IF;\r\n  END IF;\r\n  \r\n  RETURN new;\r\nend\r\n$function$","parameters":[{"name":"Returns","description":null,"mode":"OUT","data_type":"trigger","custom_fields":{}}],"dependencies":{"uses":[],"used_by":[]},"imported_at":"2024-02-15 12:25"};