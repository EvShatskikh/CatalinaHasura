window.repositoryObject = {"parameters_custom_fields":[],"object_id":"f191","name":"public.get_matrix_filters","subtype":"FUNCTION","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Hasura","id":"d4"}},{"field":"Schema","value":"public"},{"field":"Name","value":"get_matrix_filters"},{"field":"Type","value":"Function"}],"script":"CREATE OR REPLACE FUNCTION public.get_matrix_filters(_filter_name text, _filter_name2 text DEFAULT NULL::text, _filter_name3 text DEFAULT NULL::text, _month integer DEFAULT 0, _region text DEFAULT NULL::text, _ids bigint[] DEFAULT ARRAY[]::bigint[], _matrix_id integer DEFAULT NULL::integer, _search text DEFAULT NULL::text, _info_filters text DEFAULT NULL::text, _path_filters text DEFAULT NULL::text, _search_filters text DEFAULT NULL::text)\r\n RETURNS SETOF matrix_filters_f\r\n LANGUAGE plpgsql\r\n STABLE\r\nAS $function$\r\nDECLARE\r\n  select_query text;\r\nBEGIN\r\n    select_query := 'SELECT * FROM (SELECT distinct info->>' || quote_literal(_filter_name) || ' as name, ' \r\n      || CASE WHEN _filter_name2 IS NOT NULL THEN ' info->>' ||  quote_literal(_filter_name2) ELSE ' null ' END || ' as name2, '\r\n      || CASE WHEN _filter_name3 IS NOT NULL THEN ' info->>' ||  quote_literal(_filter_name3) ELSE ' null ' END || ' as name3 '\r\n      || ' FROM pos p ';\r\n   \r\n       /* Если есть поиск по территории - добавляем join */\r\n    IF _path_filters IS NOT NULL THEN\r\n        select_query := select_query || ' LEFT JOIN org_structure o ON o.id = p.org_structure_id ';\r\n    END IF;\r\n    select_query := select_query || ' WHERE for_matrix = true  ';\r\n\r\n    /* ids */\r\n    IF array_length(_ids,1) > 0 THEN\r\n        select_query := select_query || ' AND p.id IN (' || array_to_string(_ids, ', ') || ')  ';\r\n    END IF;\r\n\r\n    /* матрица (0 - точки без матрицы, null - не фильтруем по матрице)*/\r\n    IF _matrix_id IS NOT NULL THEN\r\n      IF _matrix_id = 0 THEN\r\n        select_query := select_query || ' AND NOT EXISTS (SELECT * FROM matrix_m2m_pos m2p WHERE m2p.pos_id = p.id AND m2p.month = ' || _month || ')';\r\n      ELSE\r\n        select_query := select_query || ' AND EXISTS (SELECT * FROM matrix_m2m_pos m2p WHERE m2p.pos_id = p.id AND m2p.matrix_id = ' || _matrix_id || ')';\r\n      END IF;\r\n    END IF;\r\n\r\n    /* разрешенная страна */\r\n    IF _region IS NOT NULL THEN\r\n        select_query := select_query || ' AND p.region SIMILAR TO ' || quote_literal(_region);\r\n    END IF;\r\n\r\n    /* поиск по фильтрам */\r\n    IF _info_filters IS NOT NULL THEN\r\n        select_query := select_query ||  _info_filters;\r\n    END IF;\r\n\r\n    /* поиск по территории */\r\n    IF _path_filters IS NOT NULL THEN\r\n        select_query := select_query ||  _path_filters;\r\n    END IF;\r\n    \r\n    /* поисковое слово */\r\n    IF _search IS NOT NULL THEN\r\n        select_query := select_query || ' AND fts_col @@ websearch_to_tsquery(''russian'', ' || quote_literal(_search) || ')  ';\r\n    END IF;\r\n\r\n    select_query := select_query || ' ) filters ';\r\n\r\n    /* поиск по названию фильтра */\r\n    IF _search_filters IS NOT NULL THEN\r\n        select_query := select_query || ' WHERE name ILIKE ' || quote_literal('%' || _search_filters || '%')\r\n          || ' OR name2 ILIKE ' || quote_literal('%' || _search_filters || '%')\r\n          || ' OR name3 ILIKE ' || quote_literal('%' || _search_filters || '%');\r\n    END IF;\r\n\r\n    \r\n    select_query := select_query || ' ORDER BY name';\r\n\r\n    select_query := select_query || ' LIMIT 500 ';\r\n\r\n    RETURN QUERY EXECUTE select_query;\r\nEND\r\n$function$","parameters":[{"name":"Returns","description":null,"mode":"OUT","data_type":"matrix_filters_f","custom_fields":{}},{"name":"_filter_name","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_filter_name2","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_filter_name3","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_month","description":null,"mode":"IN","data_type":"integer","custom_fields":{}},{"name":"_region","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_ids","description":null,"mode":"IN","data_type":"ARRAY","custom_fields":{}},{"name":"_matrix_id","description":null,"mode":"IN","data_type":"integer","custom_fields":{}},{"name":"_search","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_info_filters","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_path_filters","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_search_filters","description":null,"mode":"IN","data_type":"text","custom_fields":{}}],"dependencies":null,"imported_at":"2023-11-29 12:21"};