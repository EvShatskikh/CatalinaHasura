window.repositoryObject = {"parameters_custom_fields":[],"object_id":"f204","name":"public.get_ts_filters","subtype":"FUNCTION","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Hasura","id":"d4"}},{"field":"Schema","value":"public"},{"field":"Name","value":"get_ts_filters"},{"field":"Type","value":"Function"}],"script":"CREATE OR REPLACE FUNCTION public.get_ts_filters(hasura_session json, _tsids text DEFAULT NULL::text, _search text DEFAULT NULL::text)\r\n RETURNS SETOF view_filter_options\r\n LANGUAGE plpgsql\r\n STABLE\r\nAS $function$ \r\nDECLARE userTsJson jsonb;\r\nuserTs text [];\r\nuserRegionsJson jsonb;\r\nuserRegions text [];\r\nselect_query text;\r\nBEGIN\r\n/* залогиненый юзер */\r\nSELECT\r\n  pos_ts,\r\n  regions INTO userTsJson,\r\n  userRegionsJson\r\nFROM\r\n  public.user u\r\nWHERE\r\n  email = (hasura_session->>'x-hasura-user-id')::text;\r\n\r\n  select_query := 'SELECT distinct info->>''tsId'' as id, info->>''ts'' as name FROM pos ';\r\nselect_query := select_query || 'WHERE info->>''tsId'' IS NOT NULL ';\r\n  /* ограничение по стране */\r\nSELECT\r\n  array(\r\n    SELECT\r\n      jsonb_array_elements_text(userRegionsJson)\r\n  ) INTO userRegions;\r\nIF array_length(userRegions, 1) > 0 THEN select_query := select_query || ' AND region IN (''' || array_to_string(userRegions, ''', ''') || ''') ';\r\n  ELSE select_query := select_query || ' AND region = ''undefined'' ';\r\nEND IF;\r\n/* ограничение по TC */\r\nSELECT\r\n  array(\r\n    SELECT\r\n      jsonb_array_elements_text(userTsJson)\r\n  ) INTO userTs;\r\nIF array_length(userTs, 1) > 0 THEN select_query := select_query || ' AND info->>''tsId'' IN(''' || array_to_string(userTs, ''', ''') || ''') ';\r\nEND IF;\r\n/* выбор по tsId  */\r\nIF _tsids IS NOT NULL THEN select_query := select_query || ' AND info->>''tsId'' IN (' || _tsids || ') ';\r\nEND IF;\r\n/* поиск по названию TC */\r\nIF _search IS NOT NULL THEN select_query := select_query || ' AND info->>''ts'' ILIKE ' || quote_literal('%' || _search || '%');\r\nEND IF;\r\nRETURN QUERY EXECUTE select_query;\r\nEND $function$","parameters":[{"name":"Returns","description":null,"mode":"OUT","data_type":"view_filter_options","custom_fields":{}},{"name":"hasura_session","description":null,"mode":"IN","data_type":"json","custom_fields":{}},{"name":"_tsids","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_search","description":null,"mode":"IN","data_type":"text","custom_fields":{}}],"dependencies":null,"imported_at":"2023-11-29 12:21"};