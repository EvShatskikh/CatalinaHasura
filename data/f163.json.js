window.repositoryObject = {"parameters_custom_fields":[],"object_id":"f163","name":"public.call_upsert_trigger","subtype":"FUNCTION","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Hasura","id":"d4"}},{"field":"Schema","value":"public"},{"field":"Name","value":"call_upsert_trigger"},{"field":"Type","value":"Function"}],"script":"CREATE OR REPLACE FUNCTION public.call_upsert_trigger()\r\n RETURNS trigger\r\n LANGUAGE plpgsql\r\nAS $function$  \r\nDECLARE\r\n  _fts tsvector;\r\n  _name text;\r\n  _random_uuid uuid;\r\nbegin  \r\n \r\n  /* Если есть изменения по индексируемым полям - формируем новый индекс*/\r\n  _random_uuid := gen_random_uuid();\r\n  IF COALESCE(new.operator,0) != COALESCE(old.operator,0) \r\n    OR COALESCE(new.pos_id,0) != COALESCE(old.pos_id,0) \r\n  THEN\r\n\r\n    _fts := array_to_tsvector(ARRAY[new.id::text, new.external_number::text, new.operator::text]);\r\n    \r\n     /* Если есть точка - добавляем в индекс код и название */\r\n    IF new.pos_id IS NOT NULL THEN\r\n        -- select pos.name || ' ' || pos.trading_name INTO _name from pos WHERE pos.id = new.pos_id;\r\n        -- _fts := _fts || ' ' || to_tsvector('simple', new.pos_id::text) || ' ' || to_tsvector('russian', _name);\r\n\r\n        _fts := _fts || ' ' || to_tsvector('simple', new.pos_id::text);\r\n    END IF;  \r\n\r\n    new.fts := _fts;\r\n\r\n  END IF; \r\n\r\n  /* Если fts пустой - пишем номер запроса и номер клиента */\r\n  IF new.fts IS NULL THEN\r\n    new.fts := array_to_tsvector(ARRAY[new.id::text, new.external_number::text]);\r\n  END IF; \r\n\r\n  -- /* Индекс по расшифрованному тексту звонка Google */\r\n  -- IF COALESCE(new.speech,'{}'::jsonb) != COALESCE(old.speech,'{}'::jsonb) THEN\r\n  --   IF new.speech IS NOT NULL THEN\r\n  --     new.fts_speech := to_tsvector('russian', new.speech);\r\n  --   ELSE \r\n  --     new.fts_speech := NULL;\r\n  --   END IF;\r\n  -- END IF;\r\n\r\n  --   /* Индекс по расшифрованному тексту звонка MS */\r\n  -- IF COALESCE(new.speech_ms,'{}'::jsonb) != COALESCE(old.speech_ms,'{}'::jsonb) THEN\r\n  --   IF new.speech_ms IS NOT NULL THEN\r\n  --     new.fts_speech_ms := to_tsvector('russian', new.speech_ms);\r\n  --   ELSE \r\n  --     new.fts_speech_ms := NULL;\r\n  --   END IF;\r\n  -- END IF;\r\n\r\n  return new;\r\nend  \r\n$function$","parameters":[{"name":"Returns","description":null,"mode":"OUT","data_type":"trigger","custom_fields":{}}],"dependencies":{"uses":[],"used_by":[]},"imported_at":"2024-02-15 12:25"};