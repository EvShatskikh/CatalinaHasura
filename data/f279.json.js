window.repositoryObject = {"parameters_custom_fields":[],"object_id":"f279","name":"public.search_in_out_count","subtype":"FUNCTION","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Hasura","id":"d4"}},{"field":"Schema","value":"public"},{"field":"Name","value":"search_in_out_count"},{"field":"Type","value":"Function"}],"script":"CREATE OR REPLACE FUNCTION public.search_in_out_count(_datefrom date DEFAULT NULL::date, _dateto date DEFAULT NULL::date, _is_active text DEFAULT ''::text, _region text DEFAULT NULL::text, _search text DEFAULT NULL::text, _id integer DEFAULT NULL::integer, _created_by text DEFAULT NULL::text, _info_filters text DEFAULT NULL::text, _path_filters text DEFAULT NULL::text)\r\n RETURNS SETOF return_int_f\r\n LANGUAGE plpgsql\r\n STABLE\r\nAS $function$\r\nDECLARE\r\n  select_query text;\r\nBEGIN\r\n    select_query := 'SELECT count(id) as value FROM in_out io WHERE is_active = true ';\r\n\r\n    /* фільтр по даті: _datefrom тут виступає як now() */\r\n    /* для можливого фільтру по датам */\r\n      /* активні - сьогоднішня дата більша за _datefrom і менша за date_to */\r\n      IF _is_active = 'current' AND _datefrom IS NOT NULL THEN\r\n        select_query := select_query || ' AND ( date_from <=  ' || quote_literal(_datefrom);\r\n        select_query := select_query || ' AND date_to >=  ' || quote_literal(_datefrom) || ' ) ';\r\n      END IF;\r\n      /* завершені - date_to менша за date_from  */\r\n      IF _is_active = 'completed' AND _datefrom IS NOT NULL THEN\r\n       -- select_query := select_query || ' AND ( date_from >  ' || quote_literal(_datefrom);\r\n        select_query := select_query || ' AND date_to <  ' || quote_literal(_datefrom);\r\n      END IF;\r\n      /* майбутні - date_from більша за _datefrom  */\r\n      IF _is_active = 'future' AND _datefrom IS NOT NULL THEN\r\n        select_query := select_query || ' AND date_from >  ' || quote_literal(_datefrom);\r\n      END IF;\r\n\r\n    /* разрешенная страна */\r\n    IF _region IS NOT NULL THEN\r\n        select_query := select_query || ' AND region SIMILAR TO ' || quote_literal(_region);\r\n    END IF;\r\n\r\n    /* поиск по названию и id  */\r\n    IF _search IS NOT NULL THEN\r\n      select_query := select_query || ' AND ( ';\r\n      \r\n      IF _id IS NOT NULL THEN  \r\n        select_query := select_query || ' id = ' ||  _id || ' OR ';\r\n      END IF;\r\n      \r\n      select_query := select_query || ' name ILIKE ' || quote_literal('%' || _search || '%') || ') ';\r\n    END IF;\r\n\r\n    /* поиск по создателю */\r\n    IF _created_by IS NOT NULL THEN\r\n      select_query := select_query || ' AND created_by_id = ' || quote_literal(_created_by);\r\n    END IF;\r\n\r\n    /* поиск по фильтрам , o.path_info as path_info  */\r\n    IF _info_filters IS NOT NULL OR _path_filters IS NOT NULL THEN\r\n        select_query := select_query || ' AND EXISTS (SELECT p.id FROM pos p '\r\n            || ' JOIN in_out_m2m_pos in2p ON in2p.in_out_id = io.id AND in2p.pos_id = p.id ';\r\n\r\n        IF _path_filters IS NOT NULL THEN\r\n          select_query := select_query || ' LEFT JOIN org_structure o ON o.id = p.org_structure_id ';\r\n        END IF;\r\n\r\n        select_query := select_query || ' WHERE for_matrix = true ';\r\n\r\n        IF _info_filters IS NOT NULL THEN\r\n          select_query := select_query ||  _info_filters;\r\n        END IF;\r\n\r\n        IF _path_filters IS NOT NULL THEN\r\n          select_query := select_query ||  _path_filters;\r\n        END IF;\r\n\r\n         select_query := select_query || ' ) ';\r\n    END IF;\r\n\r\n    RETURN QUERY EXECUTE select_query;\r\nEND\r\n$function$","parameters":[{"name":"Returns","description":null,"mode":"OUT","data_type":"return_int_f","custom_fields":{}},{"name":"_datefrom","description":null,"mode":"IN","data_type":"date","custom_fields":{}},{"name":"_dateto","description":null,"mode":"IN","data_type":"date","custom_fields":{}},{"name":"_is_active","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_region","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_search","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_id","description":null,"mode":"IN","data_type":"integer","custom_fields":{}},{"name":"_created_by","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_info_filters","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_path_filters","description":null,"mode":"IN","data_type":"text","custom_fields":{}}],"dependencies":{"uses":[],"used_by":[]},"imported_at":"2024-02-15 12:25"};