window.repositoryObject = {"parameters_custom_fields":[],"object_id":"f197","name":"public.get_provider","subtype":"FUNCTION","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Hasura","id":"d4"}},{"field":"Schema","value":"public"},{"field":"Name","value":"get_provider"},{"field":"Type","value":"Function"}],"script":"CREATE OR REPLACE FUNCTION public.get_provider(hasura_session json)\r\n RETURNS SETOF provider\r\n LANGUAGE plpgsql\r\n STABLE\r\nAS $function$\r\nDECLARE\r\n  acl_path_array text[];\r\n  acl_path text;\r\n  parts text[];\r\n  acl_regexp text[];\r\n  m3_ids uuid[] default null;\r\nBEGIN\r\n    /* разрешенные ветки иерархии сотрудника */\r\n    select array(SELECT path FROM user_acl ua\r\n    JOIN org_structure os ON os.id = ua.org_structure_id\r\n    WHERE ua.user_id = hasura_session->>'x-hasura-user-id') INTO acl_path_array;\r\n\r\n    /* если есть ограничение по орг структуре - выбираем разрешенных провайдеров */\r\n    IF array_length(acl_path_array, 1) > 0 THEN\r\n      /* разрешенные ветки M3 и выше */\r\n      FOREACH acl_path IN ARRAY acl_path_array\r\n      LOOP\r\n        parts := string_to_array(acl_path, '/');\r\n        \r\n        IF array_length(parts,1) < 5 THEN\r\n          acl_regexp := array_append(acl_regexp, acl_path || '%');\r\n        ELSE\r\n          acl_regexp := array_append(acl_regexp, parts[1] || '/' || parts[2] || '/' || parts[3] || '/' || parts[4] || '%');\r\n        END IF; \r\n      END LOOP;\r\n\r\n      /* разрешенные М3 */\r\n      IF array_length(acl_regexp, 1) > 0 THEN\r\n          select array(SELECT id FROM org_structure WHERE hierlevel = 3 AND path LIKE ANY (acl_regexp)) INTO m3_ids;\r\n      END IF;\r\n\r\n      /* провайдеры пользователя по разрешенным М3 */\r\n      RETURN QUERY\r\n      SELECT *\r\n      FROM provider\r\n      WHERE org_structure_id = ANY (m3_ids);\r\n\r\n    /* если нет ограничение по орг структуре - все провайдеры */\r\n    ELSE\r\n      RETURN QUERY\r\n      SELECT *\r\n      FROM provider;\r\n    END IF;\r\n    RETURN;\r\nEND\r\n$function$","parameters":[{"name":"Returns","description":null,"mode":"OUT","data_type":"provider","custom_fields":{}},{"name":"hasura_session","description":null,"mode":"IN","data_type":"json","custom_fields":{}}],"dependencies":{"uses":[],"used_by":[]},"imported_at":"2024-02-15 12:25"};