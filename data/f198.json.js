window.repositoryObject = {"parameters_custom_fields":[],"object_id":"f198","name":"public.get_sector_filters","subtype":"FUNCTION","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Hasura","id":"d4"}},{"field":"Schema","value":"public"},{"field":"Name","value":"get_sector_filters"},{"field":"Type","value":"Function"}],"script":"CREATE OR REPLACE FUNCTION public.get_sector_filters(hasura_session json, _ids text DEFAULT NULL::text, _search text DEFAULT NULL::text)\r\n RETURNS SETOF view_filter_options\r\n LANGUAGE plpgsql\r\n STABLE\r\nAS $function$\r\nDECLARE userTsJson jsonb;\r\n  userTs text [];\r\n  userRegionsJson jsonb;\r\n  userRegions text [];\r\n  select_query text;\r\nBEGIN\r\n/* залогиненый юзер */\r\nSELECT\r\n  pos_ts,\r\n  regions INTO userTsJson,\r\n  userRegionsJson\r\nFROM\r\n  public.user u\r\nWHERE\r\n  email = (hasura_session->>'x-hasura-user-id')::text;\r\n\r\n  IF _search IS NOT NULL THEN\r\n   select_query := ' SELECT distinct (CASE WHEN o.name ILIKE ' || quote_literal('%' || _search || '%') || ' THEN o.name ELSE o.path_info->>''m2'' END ) as id, ';\r\n   select_query := select_query || ' (CASE WHEN o.name ILIKE ' || quote_literal('%' || _search || '%') || ' THEN o.name ELSE o.path_info->>''m2'' END ) as name ';\r\n  ELSIF _ids IS NOT NULL THEN\r\n   select_query := ' SELECT distinct (CASE WHEN o.name IN (' || _ids || ') THEN o.name ELSE o.path_info->>''m2'' END ) as id, ';\r\n   select_query := select_query || ' (CASE WHEN o.name IN (' || _ids || ') THEN o.name ELSE o.path_info->>''m2'' END ) as name ';\r\n  ELSE\r\n   select_query := 'SELECT distinct o.name as id, o.name as name  ';\r\n  END IF;\r\n\r\n  select_query := select_query || ' FROM pos p LEFT JOIN org_structure o ON o.id = p.org_structure_id ';\r\n  select_query := select_query || ' WHERE p.is_active = true and o.is_active = true and o.hierlevel = 1 ';\r\n\r\n  /* ограничение по стране */\r\n  SELECT array(SELECT jsonb_array_elements_text(userRegionsJson) ) INTO userRegions;\r\n  IF array_length(userRegions, 1) > 0\r\n    THEN select_query := select_query || ' AND p.region IN (''' || array_to_string(userRegions, ''', ''') || ''') ';\r\n    ELSE select_query := select_query || ' AND p.region = ''undefined'' ';\r\n  END IF;\r\n\r\n  /* ограничение по TC */\r\n  SELECT array(SELECT jsonb_array_elements_text(userTsJson)) INTO userTs;\r\n  IF array_length(userTs, 1) > 0\r\n    THEN select_query := select_query || ' AND p.info->>''tsId'' IN(''' || array_to_string(userTs, ''', ''') || ''') ';\r\n  END IF;\r\n\r\n  /* выбор по id org  */\r\n  IF _ids IS NOT NULL\r\n    THEN select_query := select_query || ' AND ( o.name IN (' || _ids || ') OR o.path_info->>''m2'' IN (' || _ids || ')) ';\r\n  END IF;\r\n\r\n  /* поиск по названию org */\r\n  IF _search IS NOT NULL\r\n    THEN select_query := select_query || ' AND (o.name ILIKE ' || quote_literal('%' || _search || '%') || ' OR o.path_info->>''m2'' ILIKE ' || quote_literal('%' || _search || '%') || ') ';\r\n  END IF;\r\n\r\n  select_query := select_query || '  LIMIT 50 ';\r\n\r\n  RETURN QUERY EXECUTE select_query;\r\nEND\r\n$function$","parameters":[{"name":"Returns","description":null,"mode":"OUT","data_type":"view_filter_options","custom_fields":{}},{"name":"hasura_session","description":null,"mode":"IN","data_type":"json","custom_fields":{}},{"name":"_ids","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_search","description":null,"mode":"IN","data_type":"text","custom_fields":{}}],"dependencies":{"uses":[],"used_by":[]},"imported_at":"2024-02-15 12:25"};