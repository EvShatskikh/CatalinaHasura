window.repositoryObject = {"parameters_custom_fields":[],"object_id":"f147","name":"order.before_order_update","subtype":"FUNCTION","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Hasura","id":"d4"}},{"field":"Schema","value":"order"},{"field":"Name","value":"before_order_update"},{"field":"Type","value":"Function"}],"script":"CREATE OR REPLACE FUNCTION \"order\".before_order_update()\r\n RETURNS trigger\r\n LANGUAGE plpgsql\r\nAS $function$\r\nDECLARE\r\n  _issue_id integer DEFAULT null;\r\n  _sw_id bigint DEFAULT null;\r\n  _cust_id integer DEFAULT 0;\r\nBEGIN\r\n  NEW.\"updated_at\" = NOW();\r\n  IF NEW.issue_origin IS NOT NULL AND NEW.\"issue_id\" IS NULL THEN\r\n     SELECT id INTO _issue_id FROM public.issue where issue.origin = NEW.issue_origin limit 1; \r\n    NEW.\"issue_id\" = _issue_id;\r\n  END IF;\r\n  -- проставляем sw_id для заказов\r\n  IF NEW.id IS NOT NULL AND (NEW.\"cust_id\" IS NULL OR COALESCE(NEW.\"cust_id\", 0) <> COALESCE(OLD.\"cust_id\", 0))\r\n  THEN\r\n    -- sw_id 15 символов, первая цифра 9 - atlas, 3- catalina\r\n    -- sw_id 7й символ - 1\r\n    IF NEW.issue_origin LIKE 'visit_%' \r\n      THEN _sw_id := 900000100000000;\r\n      ELSE _sw_id := 300000100000000;\r\n    END IF;\r\n    -- 2-5 символ  cust_id с ведущими нулями\r\n    IF  NEW.\"cust_id\" IS NOT NULL THEN _cust_id :=  NEW.\"cust_id\"; END IF;\r\n    _sw_id := _sw_id + (_cust_id * 10000000000);\r\n     -- последние 8 симовлов = номеру/ид заказа\r\n    _sw_id := _sw_id + NEW.\"id\";\r\n    NEW.\"swe_id\" = _sw_id;\r\n  END IF;\r\n  RETURN NEW;\r\nEND;\r\n$function$","parameters":[{"name":"Returns","description":null,"mode":"OUT","data_type":"trigger","custom_fields":{}}],"dependencies":{"uses":[],"used_by":[]},"imported_at":"2024-02-15 12:25"};