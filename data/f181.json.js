window.repositoryObject = {"parameters_custom_fields":[],"object_id":"f181","name":"public.get_call_callback","subtype":"FUNCTION","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Hasura","id":"d4"}},{"field":"Schema","value":"public"},{"field":"Name","value":"get_call_callback"},{"field":"Type","value":"Function"}],"script":"CREATE OR REPLACE FUNCTION public.get_call_callback(_provider integer DEFAULT NULL::integer)\r\n RETURNS SETOF call\r\n LANGUAGE plpgsql\r\n STABLE\r\nAS $function$\r\nDECLARE\r\n  call_ids Int[];\r\nBEGIN\r\n    /* получаем ИД звонков из запросов на перезвони и потеряных звонков */\r\n    SELECT array(SELECT e.data->>'call'\r\n    FROM issue i\r\n    JOIN issue_m2m_label label ON ((label.issue_id = i.id) AND (label.label_id IN (110, 111)))\r\n    JOIN issue_event e ON ((e.issue_id = i.id) AND e.action='call' AND (e.origin = i.origin ))\r\n    WHERE i.completed_at IS NULL AND i.is_active = true AND i.provider_id = _provider\r\n    AND i.created_at >= CURRENT_DATE\r\n    LIMIT 300) INTO call_ids;\r\n\r\n    /* звонки по найденным ID */\r\n    RETURN QUERY\r\n    SELECT c.*\r\n    FROM call c\r\n    WHERE c.id = ANY (call_ids)\r\n    ORDER BY c.created_at ASC\r\n    LIMIT 30;\r\n\r\n    RETURN;\r\nEND\r\n$function$","parameters":[{"name":"Returns","description":null,"mode":"OUT","data_type":"call","custom_fields":{}},{"name":"_provider","description":null,"mode":"IN","data_type":"integer","custom_fields":{}}],"dependencies":{"uses":[],"used_by":[]},"imported_at":"2024-02-15 12:25"};