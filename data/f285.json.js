window.repositoryObject = {"parameters_custom_fields":[],"object_id":"f285","name":"public.search_matrix","subtype":"FUNCTION","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Hasura","id":"d4"}},{"field":"Schema","value":"public"},{"field":"Name","value":"search_matrix"},{"field":"Type","value":"Function"}],"script":"CREATE OR REPLACE FUNCTION public.search_matrix(_month integer, _region text DEFAULT NULL::text, _search text DEFAULT NULL::text, _id integer DEFAULT NULL::integer, _is_auto boolean DEFAULT NULL::boolean, _created_by text DEFAULT NULL::text, _without_pos boolean DEFAULT NULL::boolean, _info_filters text DEFAULT NULL::text, _path_filters text DEFAULT NULL::text, _sort_by text DEFAULT NULL::text, _desc text DEFAULT NULL::text, _limit integer DEFAULT NULL::integer, _offset integer DEFAULT 0)\r\n RETURNS SETOF matrix\r\n LANGUAGE plpgsql\r\n STABLE\r\nAS $function$\r\nDECLARE\r\n  select_query text;\r\nBEGIN\r\n    select_query := 'SELECT * FROM matrix m WHERE is_active = true AND month = ' || _month;\r\n\r\n    /* разрешенная страна */\r\n    IF _region IS NOT NULL THEN\r\n        select_query := select_query || ' AND region SIMILAR TO ' || quote_literal(_region);\r\n    END IF;\r\n\r\n    /* поиск по названию и id матрицы */\r\n    IF _search IS NOT NULL THEN\r\n      select_query := select_query || ' AND ( ';\r\n      \r\n      IF _id IS NOT NULL THEN  \r\n        select_query := select_query || ' id = ' ||  _id || ' OR ';\r\n      END IF;\r\n      \r\n      select_query := select_query || ' name ILIKE ' || quote_literal('%' || _search || '%') || ') ';\r\n    END IF;\r\n\r\n    /* поиск по авто */\r\n    IF _is_auto IS NOT NULL THEN\r\n      IF _is_auto = TRUE THEN\r\n        select_query := select_query || ' AND is_auto = TRUE ';\r\n      ELSE\r\n        select_query := select_query || ' AND is_auto = FALSE ';\r\n      END IF;\r\n    END IF;\r\n\r\n    /* поиск по авто */\r\n    IF _created_by IS NOT NULL THEN\r\n      select_query := select_query || ' AND created_by_id = ' || quote_literal(_created_by);\r\n    END IF;\r\n\r\n    /* поиск без точек */\r\n    IF _without_pos = TRUE THEN\r\n      select_query := select_query || ' AND NOT EXISTS ( SELECT * FROM matrix_m2m_pos m2p WHERE m2p.matrix_id = m.id ) ';\r\n    END IF;\r\n\r\n    /* поиск по фильтрам , o.path_info as path_info  */\r\n    IF _info_filters IS NOT NULL OR _path_filters IS NOT NULL THEN\r\n        select_query := select_query || ' AND EXISTS (SELECT p.id FROM pos p '\r\n            || ' JOIN matrix_m2m_pos m2p ON m2p.matrix_id = m.id AND m2p.pos_id = p.id ';\r\n\r\n        IF _path_filters IS NOT NULL THEN\r\n          select_query := select_query || ' LEFT JOIN org_structure o ON o.id = p.org_structure_id ';\r\n        END IF;\r\n\r\n        select_query := select_query || ' WHERE for_matrix = true ';\r\n\r\n        IF _info_filters IS NOT NULL THEN\r\n          select_query := select_query ||  _info_filters;\r\n        END IF;\r\n\r\n        IF _path_filters IS NOT NULL THEN\r\n          select_query := select_query ||  _path_filters;\r\n        END IF;\r\n\r\n         select_query := select_query || ' ) ';\r\n    END IF;\r\n\r\n    /* order by */\r\n    IF _sort_by IS NOT NULL AND _desc IS NOT NULL THEN\r\n        select_query := select_query || ' ORDER BY ' || _sort_by || ' ' || _desc;\r\n    ELSE\r\n        select_query := select_query || ' ORDER BY id DESC ';\r\n    END IF;\r\n    \r\n    /* limit */\r\n    IF _limit IS NOT NULL THEN\r\n      select_query := select_query || ' LIMIT ' || _limit || ' OFFSET ' || _offset;\r\n    END IF;\r\n\r\n    RETURN QUERY EXECUTE select_query;\r\nEND\r\n$function$","parameters":[{"name":"Returns","description":null,"mode":"OUT","data_type":"matrix","custom_fields":{}},{"name":"_month","description":null,"mode":"IN","data_type":"integer","custom_fields":{}},{"name":"_region","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_search","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_id","description":null,"mode":"IN","data_type":"integer","custom_fields":{}},{"name":"_is_auto","description":null,"mode":"IN","data_type":"boolean","custom_fields":{}},{"name":"_created_by","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_without_pos","description":null,"mode":"IN","data_type":"boolean","custom_fields":{}},{"name":"_info_filters","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_path_filters","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_sort_by","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_desc","description":null,"mode":"IN","data_type":"text","custom_fields":{}},{"name":"_limit","description":null,"mode":"IN","data_type":"integer","custom_fields":{}},{"name":"_offset","description":null,"mode":"IN","data_type":"integer","custom_fields":{}}],"dependencies":{"uses":[],"used_by":[]},"imported_at":"2024-02-15 12:25"};