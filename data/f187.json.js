window.repositoryObject = {"parameters_custom_fields":[],"object_id":"f187","name":"public.get_issue_for_callback","subtype":"FUNCTION","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Hasura","id":"d4"}},{"field":"Schema","value":"public"},{"field":"Name","value":"get_issue_for_callback"},{"field":"Type","value":"Function"}],"script":"CREATE OR REPLACE FUNCTION public.get_issue_for_callback(_external_number bigint, _label integer)\r\n RETURNS SETOF issue\r\n LANGUAGE plpgsql\r\n STABLE\r\nAS $function$\r\nDECLARE\r\n  call_to_issue jsonb;\r\n  call_ids Int[];\r\n  call_id Text;\r\nBEGIN\r\n    /* Выбираем активные запросы с меткой = _label и связанный с ними ПЕРВЫЙ звонок (через issue_events) */\r\n    SELECT jsonb_object(ARRAY(SELECT distinct on (i.id) ARRAY[ie.data->>'call', i.id::text] FROM issue i\r\n    JOIN issue_m2m_label i2l ON i2l.issue_id = i.id AND i2l.label_id = _label\r\n    JOIN issue_event ie ON ie.issue_id = i.id AND ie.action = 'call'\r\n    WHERE i.is_active = TRUE AND i.completed_at IS NULL AND i.created_at >= CURRENT_DATE\r\n    ORDER BY i.id, ie.id)) INTO call_to_issue;\r\n\r\n    /* ID найденных звонков */\r\n    SELECT ARRAY(SELECT jsonb_object_keys(call_to_issue))::Int[] INTO call_ids;\r\n\r\n    /* Ищем звонок с _external_number из найденного списка */\r\n    SELECT c.id::Text FROM call c WHERE c.id = ANY (call_ids) AND c.external_number = _external_number LIMIT 1 INTO call_id;\t\r\n\r\n    -- /* Запрос для подвязки */\r\n    RETURN QUERY\r\n    SELECT *\r\n    FROM issue\r\n    WHERE id = (call_to_issue->>call_id)::Int;\r\nEND\r\n$function$","parameters":[{"name":"Returns","description":null,"mode":"OUT","data_type":"issue","custom_fields":{}},{"name":"_external_number","description":null,"mode":"IN","data_type":"bigint","custom_fields":{}},{"name":"_label","description":null,"mode":"IN","data_type":"integer","custom_fields":{}}],"dependencies":{"uses":[],"used_by":[]},"imported_at":"2024-02-15 12:25"};